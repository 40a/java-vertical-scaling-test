type: install
id: java-memory-usage-demo
name: Java Vertical Scaling
homepage: https://github.com/jelastic/java-vertical-scaling-test
description: |
  Java vertical scaling test: 
  * Shenandoah @ AdoptOpenJDK
  * ZGC @ Oracle OpenJDK
  * G1 @ Liberica
  * C4 @ Zing
  * OpenJ9  
  * Epsilon @ Zulu
logo: https://raw.githubusercontent.com/jelastic-jps/java-memory-agent/master/images/java-agent-logo.png
globals: 
  cloudlets: 26
  common: -Xmx3g -Xms32m -XX:+UseCompressedOops
nodes:
  - nodeType: javaengine
    tag: adoptopenjdk-12.0.2
    nodeGroup: adopt
    cloudlets: ${globals.cloudlets}
    displayName: Shenandoah @ AdoptOpenJDK
    startService: false
    #-XX:ShenandoahGCHeuristics=compact is very agressive mode 
    env:
      _JAVA_OPTIONS: ${globals.common} -XX:+UnlockExperimentalVMOptions -XX:+UseShenandoahGC -XX:ShenandoahGCHeuristics=compact 
  - nodeType: javaengine
    tag: openjdk-13.ea-b31
    nodeGroup: oracle
    cloudlets: ${globals.cloudlets}
    displayName: ZGC @ Oracle OpenJDK
    startService: false
    #-XX:ZUncommitDelay=1 -XX:ZCollectionInterval=30 is very agressive mode as well, similar to Shenandoah
    env:
      _JAVA_OPTIONS: ${globals.common} -XX:+UnlockExperimentalVMOptions -XX:+UseZGC -XX:ZUncommitDelay=1 -XX:ZCollectionInterval=30
      
  - nodeType: javaengine
    tag: libericajdk-12.0.2
    nodeGroup: liberica
    cloudlets: ${globals.cloudlets}
    displayName: G1 @ Liberica
    startService: false
    env:
      _JAVA_OPTIONS: ${globals.common} -XX:+UseG1GC -XX:G1PeriodicGCInterval=1k

  - nodeType: javaengine
    tag: zulujdk-12.0.2
    nodeGroup: zulu
    cloudlets: ${globals.cloudlets}
    displayName: Epsilon @ Zulu
    startService: false
    env:
      _JAVA_OPTIONS: ${globals.common} -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC

  - nodeType: javaengine
    tag: openj9-0.15.1-12.0.2
    nodeGroup: openj9
    cloudlets: ${globals.cloudlets}
    displayName: OpenJ9
    startService: false
    env:
      OPENJ9_JAVA_OPTIONS: ${globals.common} -XX:+IdleTuningCompactOnIdle -XX:+IdleTuningGcOnIdle -XX:IdleTuningMinIdleWaitTime=1 -Xjit:waitTimeToEnterDeepIdleMode=1000

  - image: devbeta/javaengine:zing-11.0.0
    nodeGroup: zing
    cloudlets: ${globals.cloudlets}
    displayName: C4 @ Zing 
    startService: false
    env:
      _JAVA_OPTIONS: ${globals.common} -XX:-AutoTuneResourceDefaultsBasedOnXmx

onInstall:
  - cmd[*]: |-
      chmod 775 /var/run/screen
      chmod 777 /var/log/run.log
      java --uninstall
    user: root
  - cmd[*]: |-
      wget https://github.com/jelastic/java-vertical-scaling-test/raw/master/dist/app.jar
      screen -dm bash -c "(echo -ne '\n' && cat) | java -jar app.jar 30 &>> /var/log/run.log"

#  OpenJ9 memory usage should be tracked in a tricky way 
#      while true; do
#        ps -orss --no-headers --pid $(pgrep -f java | tail -n1)
#        sleep 1
#      done
